@let activePlot = existingPlot.value();
@let isEditMode = !!activePlot;

<lg-header
  [backLink]="['/']"
  [subtitle]="'Plot: ' + editorModel().name"
  title="Plot Editor"
/>

<form
  class="flex-1 space-y-4"
  (ngSubmit)="sendToWord()"
>
  <lg-content-container class="flex flex-1">
    <div class="group flex-1">
      <label
        class="app-label"
        for="name"
        >Name</label
      >
      <input
        class="app-input"
        id="name"
        [field]="editorForm.name"
        type="text"
      />
    </div>
  </lg-content-container>

  <lg-accordion>
    <lg-accordion-panel
      [title]="rangeTitle()"
      persistenceId="editor-range"
    >
      <lg-content-container class="flex flex-col space-y-4">
        <div class="space-y-2">
          <div class="grid grid-cols-2 gap-6">
            <div class="group">
              <label
                class="app-label"
                for="min-x"
                >Min X</label
              >
              <input
                class="app-input"
                id="min-x"
                [field]="editorForm.range.x.min"
                type="number"
                step="1"
              />
            </div>
            <div class="group">
              <label
                class="app-label"
                for="max-x"
                >Max X</label
              >
              <input
                class="app-input"
                id="max-x"
                [field]="editorForm.range.x.max"
                type="number"
                step="1"
              />
            </div>
          </div>

          @if (editorForm.range.x.min().errors().length) {
            <ul>
              @for (error of editorForm.range.x.min().errors(); track error) {
                <li>{{ error.message }}</li>
              }
            </ul>
          }
        </div>
        <div class="space-y-2">
          <div class="grid grid-cols-2 gap-6">
            <div class="group">
              <label
                class="app-label"
                for="min-y"
                >Min Y</label
              >
              <input
                class="app-input"
                id="min-y"
                [field]="editorForm.range.y.min"
                type="number"
                step="1"
              />
            </div>
            <div class="group">
              <label
                class="app-label"
                for="max-y"
                >Max Y</label
              >
              <input
                class="app-input"
                id="max-y"
                [field]="editorForm.range.y.max"
                type="number"
                step="1"
              />
            </div>
          </div>

          @if (editorForm.range.y.min().errors().length) {
            <ul>
              @for (error of editorForm.range.y.min().errors(); track error) {
                <li>{{ error.message }}</li>
              }
            </ul>
          }
        </div>

        <span>Kästchen: {{ squareCount() }}</span>

        <button
          class="app-button"
          (click)="autoAdjustLimits()"
          type="button"
        >
          Grenzen an Punkte/Flächen/Linien anpassen
        </button>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      title="Einstellungen"
      persistenceId="editor-settings"
    >
      <lg-content-container class="flex flex-col">
        <div class="mb-1 flex items-center">
          <input
            class="app-checkbox"
            id="show-axis"
            [field]="editorForm.showAxis"
            type="checkbox"
          />
          <label
            class="text-heading ms-2 text-sm font-medium select-none"
            for="show-axis"
            >Achsen</label
          >
        </div>
        @if (editorModel().showAxis) {
          <div class="mb-1 ml-4 flex items-center">
            <input
              class="app-checkbox"
              id="show-axis-labels"
              [field]="editorForm.showAxisLabels"
              type="checkbox"
            />
            <label
              class="text-heading ms-2 text-sm font-medium select-none"
              for="show-axis-labels"
              >Achsenbeschriftung</label
            >
          </div>
          @if (editorModel().showAxisLabels) {
            <div class="mb-4 ml-8 flex items-center">
              <input
                class="app-checkbox"
                id="place-axis-labels-inside"
                [field]="editorForm.placeAxisLabelsInside"
                type="checkbox"
              />
              <label
                class="text-heading ms-2 text-sm font-medium select-none"
                for="place-axis-labels-inside"
                >An 0-Linie anzeigen</label
              >
            </div>
          }
        }
        <div class="mb-4 flex items-center">
          <input
            class="app-checkbox"
            id="square-plots"
            [field]="editorForm.squarePlots"
            type="checkbox"
          />
          <label
            class="text-heading ms-2 text-sm font-medium select-none"
            for="square-plots"
            >Plot quadratisch generieren</label
          >
        </div>
        <div class="flex items-center">
          <input
            class="app-checkbox"
            id="limit-equals-value-range"
            [field]="editorForm.automaticallyAdjustLimitsToValueRange"
            type="checkbox"
          />
          <label
            class="text-heading ms-2 text-sm font-medium select-none"
            for="limit-equals-value-range"
            >Grenzen automatisch dem Wertebereich anpassen</label
          >
        </div>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="functionsTitle()"
      persistenceId="editor-functions"
    >
      <lg-content-container class="flex flex-col space-y-2">
        <div class="text-heading mb-2.5 flex justify-end text-sm font-medium">
          <span class="inline-block"
            ><button
              (click)="addFx()"
              type="button"
            >
              <fa-icon [icon]="faPlusCircle" /> Funktion hinzufügen
            </button></span
          >
        </div>
        @for (control of editorForm.fnx; let index = $index; track index) {
          <div>
            <div class="flex flex-1 flex-col">
              <label
                class="app-label"
                [for]="'fnx-' + $index"
                >Funktion {{ index + 1 }}: f(x) =
              </label>

              <div class="flex items-center space-x-2">
                <input
                  class="app-input"
                  [field]="control.fnx"
                  [id]="'fnx-' + $index"
                  type="text"
                  spellcheck="false"
                  autocorrect="off"
                  autocomplete="off"
                  autocapitalize="off"
                />

                <input
                  class="h-8 w-8 shrink-0 border-none"
                  [field]="control.color"
                  type="color"
                />

                <button
                  (click)="removeFx(index)"
                  type="button"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>
            <lg-math-display [math]="control.fnx().value()" />
          </div>
        }
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="markersTitle()"
      persistenceId="editor-markers"
    >
      <lg-content-container class="flex flex-col space-y-2">
        <div class="text-heading mb-2.5 flex justify-end text-sm font-medium">
          <span class="inline-block"
            ><button
              (click)="addMarker()"
              type="button"
            >
              <fa-icon [icon]="faPlusCircle" /> Punkt hinzufügen
            </button></span
          >
        </div>
        @for (control of editorForm.markers; let index = $index; track index) {
          <div>
            <div class="flex items-center space-x-2">
              <input
                class="app-input"
                [field]="control.text"
                type="text"
                spellcheck="false"
                autocorrect="off"
                autocomplete="off"
                autocapitalize="off"
              />

              <input
                class="app-input"
                [field]="control.x"
                type="number"
              />
              <input
                class="app-input"
                [field]="control.y"
                type="number"
              />

              <button
                (click)="removeMarker(index)"
                type="button"
              >
                <fa-icon [icon]="faTrashCan" />
              </button>
            </div>
          </div>
        }
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="areasTitle()"
      persistenceId="editor-areas"
    >
      <lg-content-container class="flex flex-col space-y-2">
        <div class="text-heading mb-2.5 flex justify-end text-sm font-medium">
          <span class="inline-block"
            ><button
              (click)="addArea()"
              type="button"
            >
              <fa-icon [icon]="faPlusCircle" /> Fläche hinzufügen
            </button></span
          >
        </div>
        @for (
          control of editorForm.areas;
          let areaIndex = $index;
          track areaIndex
        ) {
          <div class="border-default-medium rounded-base border p-2">
            <div class="mb-2 flex items-center justify-between">
              <span class="text-heading text-sm font-medium"
                >Fläche {{ areaIndex + 1 }}</span
              >
              <div class="flex items-center space-x-2">
                <input
                  class="h-8 w-8 shrink-0 border-none"
                  [field]="control.color"
                  type="color"
                />
                <button
                  (click)="removeArea(areaIndex)"
                  type="button"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>
            <div class="mb-2 flex justify-end">
              <button
                class="text-xs"
                (click)="addAreaPoint(areaIndex)"
                type="button"
              >
                <fa-icon [icon]="faPlusCircle" /> Punkt hinzufügen
              </button>
            </div>
            @for (
              point of control.points;
              let pointIndex = $index;
              track pointIndex
            ) {
              <div class="mb-1 flex items-center space-y-4 space-x-2">
                <div class="flex flex-1 flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'area-' + areaIndex + '-x-' + pointIndex"
                    >X{{ pointIndex + 1 }}</label
                  >
                  <input
                    class="app-input"
                    [field]="point.x"
                    [id]="'area-' + areaIndex + '-x-' + pointIndex"
                    type="number"
                  />
                </div>
                <div class="flex flex-1 flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'area-' + areaIndex + '-y-' + pointIndex"
                    >Y{{ pointIndex + 1 }}</label
                  >
                  <input
                    class="app-input"
                    [field]="point.y"
                    [id]="'area-' + areaIndex + '-y-' + pointIndex"
                    type="number"
                  />
                </div>
                <button
                  class="mt-5"
                  (click)="removeAreaPoint(areaIndex, pointIndex)"
                  type="button"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            }
          </div>
        }
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="linesTitle()"
      persistenceId="editor-lines"
    >
      <lg-content-container class="flex flex-col space-y-2">
        <div class="text-heading mb-2.5 flex justify-end text-sm font-medium">
          <span class="inline-block"
            ><button
              (click)="addLine()"
              type="button"
            >
              <fa-icon [icon]="faPlusCircle" /> Linie hinzufügen
            </button></span
          >
        </div>
        @for (control of editorForm.lines; let index = $index; track index) {
          <div class="border-default-medium rounded-base border p-2">
            <div class="mb-2 flex items-center justify-between">
              <span class="text-heading text-sm font-medium"
                >Linie {{ index + 1 }}</span
              >
              <div class="flex items-center space-x-2">
                <input
                  class="h-8 w-8 shrink-0 border-none"
                  [field]="control.color"
                  type="color"
                />
                <button
                  (click)="removeLine(index)"
                  type="button"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row">
              <div class="flex space-x-2">
                <div class="flex flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'line-x1-' + $index"
                    >X1</label
                  >
                  <input
                    class="app-input"
                    [field]="control.x1"
                    [id]="'line-x1-' + $index"
                    type="number"
                  />
                </div>
                <div class="flex flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'line-y1-' + $index"
                    >Y1</label
                  >
                  <input
                    class="app-input"
                    [field]="control.y1"
                    [id]="'line-y1-' + $index"
                    type="number"
                  />
                </div>
              </div>
              <div class="flex space-x-2">
                <div class="flex flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'line-x2-' + $index"
                    >X2</label
                  >
                  <input
                    class="app-input"
                    [field]="control.x2"
                    [id]="'line-x2-' + $index"
                    type="number"
                  />
                </div>
                <div class="flex flex-col">
                  <label
                    class="app-label text-xs"
                    [for]="'line-y2-' + $index"
                    >Y2</label
                  >
                  <input
                    class="app-input"
                    [field]="control.y2"
                    [id]="'line-y2-' + $index"
                    type="number"
                  />
                </div>
              </div>
            </div>
          </div>
        }
      </lg-content-container>
    </lg-accordion-panel>
  </lg-accordion>

  <lg-content-container>
    <button
      class="app-button"
      type="submit"
    >
      @if (isEditMode) {
        Aktualisieren
      } @else {
        In Word einbinden
      }
    </button>
  </lg-content-container>
</form>

@let fnx = editorForm().value().fnx;
@if (fnx) {
  <lg-section
    title="Vorschau"
    subtitle="Die Vorschau entspricht nicht der Größe des Bildes, das in Word eingefügt
      wird."
  />
  <lg-plot-preview
    [plot]="editorModel()"
    [plotSettings]="plotSettings()"
  />
}
