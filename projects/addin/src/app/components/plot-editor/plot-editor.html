@let activePlot = existingPlot.value();
@let isEditMode = !!activePlot;

<lg-header
  [backLink]="['/']"
  [subtitle]="'Plot: ' + editorModel().name"
  title="Plot Editor"
/>

<form
  class="flex flex-1 flex-col"
  (ngSubmit)="sendToWord()"
>
  <lg-content-container class="flex flex-1">
    <div class="flex-1">
      <label
        class="app-label"
        for="name"
        >Name</label
      >
      <input
        class="app-input"
        id="name"
        [field]="editorForm.name"
        type="text"
        placeholder="z.B. Parabel, Sinus, ..."
      />
    </div>
  </lg-content-container>

  <lg-accordion class="flex-1">
    <lg-accordion-panel
      [title]="rangeTitle()"
      persistenceId="editor-range"
    >
      <lg-content-container class="flex flex-col space-y-3">
        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <div class="mb-2 text-xs font-medium text-gray-500">X-Achse</div>
          <div class="flex gap-3">
            <div class="flex-1">
              <label
                class="mb-1 block text-xs text-gray-600"
                for="min-x"
                >Min</label
              >
              <input
                class="app-input"
                id="min-x"
                [field]="editorForm.range.x.min"
                type="number"
                step="1"
              />
            </div>
            <div class="flex-1">
              <label
                class="mb-1 block text-xs text-gray-600"
                for="max-x"
                >Max</label
              >
              <input
                class="app-input"
                id="max-x"
                [field]="editorForm.range.x.max"
                type="number"
                step="1"
              />
            </div>
          </div>
          @if (editorForm.range.x.min().errors().length) {
            <ul class="mt-2 text-xs text-red-600">
              @for (error of editorForm.range.x.min().errors(); track error) {
                <li>{{ error.message }}</li>
              }
            </ul>
          }
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <div class="mb-2 text-xs font-medium text-gray-500">Y-Achse</div>
          <div class="flex gap-3">
            <div class="flex-1">
              <label
                class="mb-1 block text-xs text-gray-600"
                for="min-y"
                >Min</label
              >
              <input
                class="app-input"
                id="min-y"
                [field]="editorForm.range.y.min"
                type="number"
                step="1"
              />
            </div>
            <div class="flex-1">
              <label
                class="mb-1 block text-xs text-gray-600"
                for="max-y"
                >Max</label
              >
              <input
                class="app-input"
                id="max-y"
                [field]="editorForm.range.y.max"
                type="number"
                step="1"
              />
            </div>
          </div>
          @if (editorForm.range.y.min().errors().length) {
            <ul class="mt-2 text-xs text-red-600">
              @for (error of editorForm.range.y.min().errors(); track error) {
                <li>{{ error.message }}</li>
              }
            </ul>
          }
        </div>

        <div
          class="flex items-center justify-between rounded-lg bg-gray-100 px-3 py-2"
        >
          <span class="text-sm text-gray-600">Kästchen:</span>
          <span class="font-medium text-gray-800">{{ squareCount() }}</span>
        </div>

        <button
          class="app-button w-full text-sm"
          (click)="autoAdjustLimits()"
          type="button"
        >
          Grenzen automatisch anpassen
        </button>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      title="Einstellungen"
      persistenceId="editor-settings"
    >
      <lg-content-container class="flex flex-col space-y-2">
        <label
          class="flex cursor-pointer items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 transition-colors hover:bg-gray-50"
        >
          <input
            class="app-checkbox"
            id="show-axis"
            [field]="editorForm.showAxis"
            type="checkbox"
          />
          <span class="text-sm text-gray-700">Achsen anzeigen</span>
        </label>

        @if (editorModel().showAxis) {
          <label
            class="ml-4 flex cursor-pointer items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 transition-colors hover:bg-gray-50"
          >
            <input
              class="app-checkbox"
              id="show-axis-labels"
              [field]="editorForm.showAxisLabels"
              type="checkbox"
            />
            <span class="text-sm text-gray-700">Achsenbeschriftung</span>
          </label>

          @if (editorModel().showAxisLabels) {
            <label
              class="ml-8 flex cursor-pointer items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 transition-colors hover:bg-gray-50"
            >
              <input
                class="app-checkbox"
                id="place-axis-labels-inside"
                [field]="editorForm.placeAxisLabelsInside"
                type="checkbox"
              />
              <span class="text-sm text-gray-700">An 0-Linie anzeigen</span>
            </label>
          }
        }

        <label
          class="flex cursor-pointer items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 transition-colors hover:bg-gray-50"
        >
          <input
            class="app-checkbox"
            id="square-plots"
            [field]="editorForm.squarePlots"
            type="checkbox"
          />
          <span class="text-sm text-gray-700">Plot quadratisch generieren</span>
        </label>

        <label
          class="flex cursor-pointer items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 transition-colors hover:bg-gray-50"
        >
          <input
            class="app-checkbox"
            id="limit-equals-value-range"
            [field]="editorForm.automaticallyAdjustLimitsToValueRange"
            type="checkbox"
          />
          <span class="text-sm text-gray-700"
            >Grenzen automatisch anpassen</span
          >
        </label>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="functionsTitle()"
      persistenceId="editor-functions"
    >
      <lg-content-container class="flex flex-col space-y-3">
        @for (control of editorForm.fnx; let index = $index; track index) {
          <div class="rounded-lg border border-gray-200 bg-white p-3 shadow-xs">
            <div class="mb-2 flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500"
                >Funktion {{ index + 1 }}</span
              >
              <div class="flex items-center gap-2">
                <input
                  class="h-7 w-7 cursor-pointer rounded border-none"
                  [field]="control.color"
                  type="color"
                  title="Farbe wählen"
                />
                <button
                  class="flex h-7 w-7 items-center justify-center rounded text-gray-400 transition-colors hover:bg-red-50 hover:text-red-500"
                  (click)="removeFx(index)"
                  type="button"
                  title="Funktion entfernen"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600">f(x) =</span>
              <input
                class="app-input flex-1"
                [field]="control.fnx"
                [id]="'fnx-' + $index"
                type="text"
                spellcheck="false"
                autocorrect="off"
                autocomplete="off"
                autocapitalize="off"
                placeholder="z.B. x^2, sin(x), ..."
              />
            </div>
            <lg-math-display [math]="control.fnx().value()" />
          </div>
        }

        <button
          class="hover:border-brand hover:bg-brand/5 hover:text-brand flex w-full items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 bg-white py-3 text-sm text-gray-600 transition-colors"
          (click)="addFx()"
          type="button"
        >
          <fa-icon [icon]="faPlusCircle" />
          <span>Funktion hinzufügen</span>
        </button>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="markersTitle()"
      persistenceId="editor-markers"
    >
      <lg-content-container class="flex flex-col space-y-3">
        @for (control of editorForm.markers; let index = $index; track index) {
          <div class="rounded-lg border border-gray-200 bg-white p-3 shadow-xs">
            <div class="mb-2 flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500"
                >Punkt {{ index + 1 }}</span
              >
              <button
                class="flex h-7 w-7 items-center justify-center rounded text-gray-400 transition-colors hover:bg-red-50 hover:text-red-500"
                (click)="removeMarker(index)"
                type="button"
                title="Punkt entfernen"
              >
                <fa-icon [icon]="faTrashCan" />
              </button>
            </div>
            <div class="mb-2">
              <label class="mb-1 block text-xs text-gray-600"
                >Beschriftung</label
              >
              <input
                class="app-input"
                [field]="control.text"
                type="text"
                spellcheck="false"
                autocorrect="off"
                autocomplete="off"
                autocapitalize="off"
                placeholder="z.B. P, A, ..."
              />
            </div>
            <div class="flex gap-3">
              <div class="flex-1">
                <label class="mb-1 block text-xs text-gray-600">X</label>
                <input
                  class="app-input"
                  [field]="control.x"
                  type="number"
                />
              </div>
              <div class="flex-1">
                <label class="mb-1 block text-xs text-gray-600">Y</label>
                <input
                  class="app-input"
                  [field]="control.y"
                  type="number"
                />
              </div>
            </div>
          </div>
        }

        <button
          class="hover:border-brand hover:bg-brand/5 hover:text-brand flex w-full items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 bg-white py-3 text-sm text-gray-600 transition-colors"
          (click)="addMarker()"
          type="button"
        >
          <fa-icon [icon]="faPlusCircle" />
          <span>Punkt hinzufügen</span>
        </button>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="areasTitle()"
      persistenceId="editor-areas"
    >
      <lg-content-container class="flex flex-col space-y-3">
        @for (
          control of editorForm.areas;
          let areaIndex = $index;
          track areaIndex
        ) {
          <div class="rounded-lg border border-gray-200 bg-white p-3 shadow-xs">
            <div class="mb-3 flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500"
                >Fläche {{ areaIndex + 1 }}</span
              >
              <div class="flex items-center gap-2">
                <input
                  class="h-7 w-7 cursor-pointer rounded border-none"
                  [field]="control.color"
                  type="color"
                  title="Farbe wählen"
                />
                <button
                  class="flex h-7 w-7 items-center justify-center rounded text-gray-400 transition-colors hover:bg-red-50 hover:text-red-500"
                  (click)="removeArea(areaIndex)"
                  type="button"
                  title="Fläche entfernen"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>

            <div class="space-y-2">
              @for (
                point of control.points;
                let pointIndex = $index;
                track pointIndex
              ) {
                <div class="flex items-end gap-2 rounded-md bg-gray-50 p-2">
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'area-' + areaIndex + '-x-' + pointIndex"
                      >X{{ pointIndex + 1 }}</label
                    >
                    <input
                      class="app-input"
                      [field]="point.x"
                      [id]="'area-' + areaIndex + '-x-' + pointIndex"
                      type="number"
                    />
                  </div>
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'area-' + areaIndex + '-y-' + pointIndex"
                      >Y{{ pointIndex + 1 }}</label
                    >
                    <input
                      class="app-input"
                      [field]="point.y"
                      [id]="'area-' + areaIndex + '-y-' + pointIndex"
                      type="number"
                    />
                  </div>
                  <button
                    class="mb-1 flex h-8 w-8 shrink-0 items-center justify-center rounded text-gray-400 transition-colors hover:bg-red-100 hover:text-red-500"
                    (click)="removeAreaPoint(areaIndex, pointIndex)"
                    type="button"
                    title="Punkt entfernen"
                  >
                    <fa-icon [icon]="faTrashCan" />
                  </button>
                </div>
              }
            </div>

            <button
              class="hover:border-brand hover:text-brand mt-2 flex w-full items-center justify-center gap-1 rounded-md border border-dashed border-gray-300 py-2 text-xs text-gray-500 transition-colors"
              (click)="addAreaPoint(areaIndex)"
              type="button"
            >
              <fa-icon [icon]="faPlusCircle" />
              <span>Punkt hinzufügen</span>
            </button>
          </div>
        }

        <button
          class="hover:border-brand hover:bg-brand/5 hover:text-brand flex w-full items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 bg-white py-3 text-sm text-gray-600 transition-colors"
          (click)="addArea()"
          type="button"
        >
          <fa-icon [icon]="faPlusCircle" />
          <span>Fläche hinzufügen</span>
        </button>
      </lg-content-container>
    </lg-accordion-panel>
    <lg-accordion-panel
      [title]="linesTitle()"
      persistenceId="editor-lines"
    >
      <lg-content-container class="flex flex-col space-y-3">
        @for (control of editorForm.lines; let index = $index; track index) {
          <div class="rounded-lg border border-gray-200 bg-white p-3 shadow-xs">
            <div class="mb-3 flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500"
                >Linie {{ index + 1 }}</span
              >
              <div class="flex items-center gap-2">
                <input
                  class="h-7 w-7 cursor-pointer rounded border-none"
                  [field]="control.color"
                  type="color"
                  title="Farbe wählen"
                />
                <button
                  class="flex h-7 w-7 items-center justify-center rounded text-gray-400 transition-colors hover:bg-red-50 hover:text-red-500"
                  (click)="removeLine(index)"
                  type="button"
                  title="Linie entfernen"
                >
                  <fa-icon [icon]="faTrashCan" />
                </button>
              </div>
            </div>

            <div class="space-y-2">
              <div class="rounded-md bg-gray-50 p-2">
                <div class="mb-1 text-xs font-medium text-gray-500">
                  Startpunkt
                </div>
                <div class="flex gap-3">
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'line-x1-' + $index"
                      >X</label
                    >
                    <input
                      class="app-input"
                      [field]="control.x1"
                      [id]="'line-x1-' + $index"
                      type="number"
                    />
                  </div>
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'line-y1-' + $index"
                      >Y</label
                    >
                    <input
                      class="app-input"
                      [field]="control.y1"
                      [id]="'line-y1-' + $index"
                      type="number"
                    />
                  </div>
                </div>
              </div>
              <div class="rounded-md bg-gray-50 p-2">
                <div class="mb-1 text-xs font-medium text-gray-500">
                  Endpunkt
                </div>
                <div class="flex gap-3">
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'line-x2-' + $index"
                      >X</label
                    >
                    <input
                      class="app-input"
                      [field]="control.x2"
                      [id]="'line-x2-' + $index"
                      type="number"
                    />
                  </div>
                  <div class="flex-1">
                    <label
                      class="mb-1 block text-xs text-gray-500"
                      [for]="'line-y2-' + $index"
                      >Y</label
                    >
                    <input
                      class="app-input"
                      [field]="control.y2"
                      [id]="'line-y2-' + $index"
                      type="number"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        }

        <button
          class="hover:border-brand hover:bg-brand/5 hover:text-brand flex w-full items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 bg-white py-3 text-sm text-gray-600 transition-colors"
          (click)="addLine()"
          type="button"
        >
          <fa-icon [icon]="faPlusCircle" />
          <span>Linie hinzufügen</span>
        </button>
      </lg-content-container>
    </lg-accordion-panel>
  </lg-accordion>

  <div class="sticky bottom-0 border-t border-gray-200 bg-gray-50 p-3">
    <button
      class="app-button w-full"
      type="submit"
    >
      @if (isEditMode) {
        Plot aktualisieren
      } @else {
        In Word einfügen
      }
    </button>
  </div>
</form>

@let fnx = editorForm().value().fnx;
@if (fnx) {
  <lg-section
    title="Vorschau"
    subtitle="Die Vorschau entspricht nicht der Größe des Bildes, das in Word eingefügt
      wird."
  />
  <lg-plot-preview
    [plot]="editorModel()"
    [plotSettings]="plotSettings()"
  />
}
